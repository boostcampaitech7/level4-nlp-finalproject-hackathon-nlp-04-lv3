import os
import re
import json
import asyncio
import aiohttp
import asyncpg
from datetime import datetime, timedelta
from airflow import DAG
from airflow.providers.postgres.operators.postgres import PostgresOperator
from airflow.providers.postgres.hooks.postgres import PostgresHook
from airflow.operators.python import PythonOperator
from dotenv import load_dotenv

load_dotenv()


feedback_prompt = """#### ì—­í• :   
ë‹¹ì‹ ì€ ê¸€ì“°ê¸° ì—­ëŸ‰ì´ ë¶€ì¡±í•œ í•™ìƒì—ê²Œ ì¼ê¸° ìˆ™ì œë¥¼ ë‚¸ ê¸€ì“°ê¸° ì„ ìƒë‹˜ì…ë‹ˆë‹¤.

#### ê³¼ì œ:  
í•™ìƒì´ ì‘ì„±í•œ ì¼ê¸°ë¥¼ ì½ê³ , ë¬¸ì¥ ë‹¨ìœ„ì˜ í”¼ë“œë°±ì„ ì œê³µí•´ ì£¼ì„¸ìš”. ì•„ë˜ 5ê°€ì§€ ê¸°ì¤€ì— ë¶€í•©í•˜ì§€ ì•Šì€ ë¬¸ì¥ì„ ì°¾ì•„ êµ¬ì²´ì ì¸ í”¼ë“œë°±ì„  ì œì‹œí•´ ì£¼ì„¸ìš”.

#### í”¼ë“œë°± ê¸°ì¤€:
1. ì‰½ê³  ëª…í™•í•œ ë‹¨ì–´ ì‚¬ìš©: ì´í•´í•˜ê¸° ì‰½ê³ , ì‚¬ì‹¤ì„ ìˆëŠ” ê·¸ëŒ€ë¡œ í‘œí˜„í•˜ëŠ” ë‹¨ì–´ë¥¼ ì‚¬ìš©í•´ì•¼ í•©ë‹ˆë‹¤.  
ì˜ˆì‹œ: "í˜„ìˆ˜ëŠ” í•˜ë˜ ì¼ì„ ë©ˆì¶”ê³  **ìƒë¦¬ í˜„ìƒ**ì„ í•´ê²°í–ˆë‹¤." â†’ "í˜„ìˆ˜ëŠ” í•˜ë˜ ì¼ì„ ë©ˆì¶”ê³  **ëŒ€ë³€**ì„ ë³´ì•˜ë‹¤."  
ì˜ˆì‹œ: "ë°•ì§€ì„± ì„ ìˆ˜ëŠ” **í¸í‰ì¡±**ì´ë‹¤. â†’ "ë°•ì§€ì„± ì„ ìˆ˜ëŠ” **í‰ë°œ**ì´ë‹¤."  
2. ë¬¸ë²• ê·œì¹™ ì¤€ìˆ˜: **ë§ì¶¤ë²•**ê³¼ **ë„ì–´ì“°ê¸°**ë¥¼ ì •í™•íˆ ì§€ì¼œì•¼ í•©ë‹ˆë‹¤.  
ì˜ˆì‹œ: "ë‹¤í–‰ì´ ë°¥ì„ ë¨¹ì—ˆë‹¤. â†’ ë‹¤í–‰íˆ ë°¥ì„ ë¨¹ì—ˆë‹¤."  
ì˜ˆì‹œ: "ìê¸°ì „ ì±… ì½ëŠ” ìŠµê´€ì„ ë“¤ì´ê³  ì‹¶ë‹¤." â†’ "ìê¸° ì „ ì±… ì½ëŠ” ìŠµê´€ì„ ë“¤ì´ê³  ì‹¶ë‹¤."  
3. ë¬¸ì¥ì˜ ì ì •í•œ ê¸¸ì´ì™€ ë‚´ìš© ì¤€ìˆ˜: ë¬¸ì¥ì€ **ì§€ë‚˜ì¹˜ê²Œ ê¸¸ê±°ë‚˜ ê³¼ë„í•˜ê²Œ ë§ì€ ë‚´ìš©ì„ ë‹´ì§€ ì•Šë„ë¡ ì‘ì„±**í•´ì•¼ í•©ë‹ˆë‹¤.  
ì˜ˆì‹œ: â€œìš”ì¦˜ì€ ëœ¨ê²Œì§ˆì— ì·¨ë¯¸ê°€ ìƒê²¨ ëª©ë„ë¦¬ë„ ëœ¨ê³  ê°€ë°©ë„ ëœ¨ê³  ê·¸ ë•ë¶„ì— ì‹œê°„ë„ ì˜ê°€ê³  ì ë§Œ ìê±°ë‚˜ í‹°ë¹„ë§Œ ë³´ë©´ì„œ ì‹œê°„ì„ ë³´ë‚´ì§€ëŠ” ì•ŠëŠ”ë‹¤.â€ â†’ â€œìš”ì¦˜ì€ ëœ¨ê°œì§ˆì— ì·¨ë¯¸ê°€ ìƒê²¨ ëª©ë„ë¦¬ì™€ ê°€ë°©ì„ ëœ¨ê³  ìˆë‹¤. ê·¸ ë•ë¶„ì— ì‹œê°„ì´ ì˜ ê°€ê³  ì ë§Œ ìê±°ë‚˜ TVë§Œ ë³´ì§€ ì•ŠëŠ”ë‹¤.â€  
ì˜ˆì‹œ: "íŒ€ì›ë“¤ì´ ì—¬ëŸ¬ëª¨ë¡œ ë°°ë ¤ë¥¼ í•´ì£¼ê¸°ëŠ” í•˜ì§€ë§Œ, ì—°ì°¨ê°€ ë‚®ì€ ë‚˜ë¡œì„œëŠ” 'ì ì‹¬ì— ì´ê±° ë¨¹ì–´ìš”!' í•˜ê³  ì£¼ì¥í•˜ê¸°ê°€ ì¡°ê¸ˆ í˜ë“¤ì–´ì¡Œë‹¤." â†’ "íŒ€ì›ë“¤ì´ ì—¬ëŸ¬ëª¨ë¡œ ë°°ë ¤í•´ ì£¼ì§€ë§Œ, ì—°ì°¨ê°€ ë‚®ì•„ ì ì‹¬ ë©”ë‰´ë¥¼ ì£¼ì¥í•˜ê¸° ì–´ë ¤ì›Œì¡Œë‹¤."  
4. ëŠ¥ë™íƒœ ì‚¬ìš©: ë‚´ìš©ì„ ê°„ê²°í•˜ê³  ëª…í™•íˆ ì „ë‹¬í•˜ê¸° ìœ„í•´ ìˆ˜ë™íƒœ ëŒ€ì‹  ëŠ¥ë™íƒœë¡œ ë¬¸ì¥ì„ ì‘ì„±í•´ì•¼ í•©ë‹ˆë‹¤.  
ì˜ˆì‹œ: "ì‘ê°€ì— ì˜í•´ ë°§ì¤„ì´ ë˜ì ¸ì¡Œë‹¤." â†’ "ì‘ê°€ê°€ ë°§ì¤„ì„ ë˜ì¡Œë‹¤."  
ì˜ˆì‹œ: "íšŒì˜ëŠ” 7ì‹œì— ê°œìµœë  ì˜ˆì •ì…ë‹ˆë‹¤." â†’ "íšŒì˜ ì‹œê°„ì€ 7ì‹œì…ë‹ˆë‹¤."
5. ë¶€ì‚¬ ìµœì†Œí™”: ë¬¸ì¥ì„ ê°„ê²°í•˜ê²Œ ìœ ì§€í•˜ê¸° ìœ„í•´ **ë¶€ì‚¬ë¥¼ ìµœì†Œí•œìœ¼ë¡œ ì‚¬ìš©**í•´ì•¼ í•©ë‹ˆë‹¤.  
ì˜ˆì‹œ: "ê·¸ëŠ” ë¬¸ì„ **ë§¤ìš° êµ³ê²Œ** ë‹«ì•˜ë‹¤." â†’ "ê·¸ëŠ” ë¬¸ì„ **êµ³ê²Œ** ë‹«ì•˜ë‹¤."

#### ìš”êµ¬ ì‚¬í•­:
1. í”¼ë“œë°±ì´ ê°€ì¥ í•„ìš”í•œ ë¬¸ì¥ 10ê°œë¥¼ ì„ ì •í•˜ê³  ì´ì— ëŒ€í•œ í”¼ë“œë°±ì„ ì‘ì„±í•˜ì„¸ìš”.
2. ê° í”¼ë“œë°±ì— ë‹¤ìŒ 3ê°€ì§€ ë‚´ìš©ì„ í¬í•¨í•˜ì—¬ ì‘ì„±í•˜ì„¸ìš”:
    - ê¸°ì¡´ ë¬¸ì¥: í•™ìƒì´ ì‘ì„±í•œ ë¬¸ì¥ì„ **ê·¸ëŒ€ë¡œ ì œì‹œ**í•©ë‹ˆë‹¤.  
    - ì´ìœ  ë° ê°œì„ ì : 5ê°€ì§€ ê¸°ì¤€ ì¤‘ ë¶€í•©í•˜ì§€ ì•Šì€ ê¸°ì¤€ì„ ì°¾ì•„, ê·¸ ì´ìœ ë¥¼ ì„¤ëª…í•˜ê³  ê°œì„ ì ì„ ì œì‹œí•©ë‹ˆë‹¤. ì´ë•Œ, **ë”°ëœ»í•˜ê³  ì¹œê·¼í•œ ì–´ì¡°**ë¡œ ì‘ì„±í•˜ì„¸ìš”.  
    - ìˆ˜ì • ë¬¸ì¥: ê°œì„ ì ì„ ë°˜ì˜í•˜ì—¬ ìˆ˜ì •ëœ ë¬¸ì¥ì„ ì œì‹œí•©ë‹ˆë‹¤.

#### ì˜ˆì‹œ: 
**ì¼ê¸°**:  
ì•ˆê²½ì„ ì¼ëŠ”ë°ë„ ì‹œì•¼ê°€ ë™ê·¸ë—ê³  ëª½ê¸€ëª½ê¸€í•œ ë¹› ë©ì–´ë¦¬ë¡œ ê²¹ì³ ë³´ì˜€ë‹¤. ëˆˆ ì•ìœ¼ë¡œëŠ” ê¸¸ì´ ì­‰ ë»—ì–´ ìˆì—ˆì§€ë§Œ ì € ë„íŠ¸ë¨¸ë¦¬ì˜ ê±´ë¬¼ ê¼­ëŒ€ê¸°ë¥¼ ë°”ë¼ë³´ë ¤ í•´ë„ ì´ˆì ì´ ì˜ ì¡íˆì§€ ì•Šì•˜ë‹¤. ë‹¹ì¥ ì½” ì•ì˜ ë‚´ ì† ì¡°ì°¨ íë¦¿í•˜ê²Œ í¼ì ¸ ë³´ì´ëŠ”ë° ë¨¼ ê³³ì„ ë³´ë ¤ê³  í•˜ë‹¤ë‹ˆ ìš©ê¸°ê°€ ê°€ìƒí•˜ë‹¤. í”¼ê³¤í–ˆë‹¤. ë§ˆê° í•˜ë‚˜ê°€ ëë‚¬ë‹¤. ì²« ì¶œë°œì„ í•˜ëŠ” ì§€í•˜ì² ì— ì•‰ì•„ ì•½ 40ë¶„ì„ ê¾¸ë²… ì¡¸ë‹¤ê°€ ë²„ìŠ¤ë¡œ 10 ë¶„ ë”. ì´ì œëŠ” ìµìˆ™í•œ ê±´ë¬¼ ì§€í•˜ë¡œ ë“¤ì–´ê°€ ì†ì„ ì”»ê³  ë‚˜ì˜¤ë©´ ì—…ë¬´ ì‹œì‘ 10ë¶„ì¯¤ ì „ì´ë‹¤. ì»´í“¨í„° ì „ì›ì„ ëˆ„ë¥´ê³  ë¶€íŒ…ì„ ê¸°ë‹¤ë¦¬ëŠ” ì•½ê°„ì˜ ì‹œê°„ ì‚¬ì´ì— ì§„í•œ ì»¤í”¼ í•œ ì”ì„ ë‚´ë¦°ë‹¤. ìë¦¬ì— ì•‰ìœ¼ë©´ ì½”ëì—ì„œ ì•ìœ¼ë¡œ ì•½ 60cmì˜ ê±°ë¦¬ë¥¼ ë‘” 32ì¸ì¹˜ ëª¨ë‹ˆí„° ë‘ ëŒ€, íƒ€ë¸”ë › í•œ ê²Œì™€ ê¸°ê³„ì‹ ë°±ì¶• í‚¤ë³´ë“œ í•œ ëŒ€, ê°ì¢… ë‹¨ì¶•í‚¤ë¥¼ ë“±ë¡í•œ ê²Œì´ë°ìš© ë§ˆìš°ìŠ¤ í•œ ê°œê°€ ì„¸íŒ…ë˜ì–´ ìˆë‹¤. ì¼ìš”í•œ í”„ë¡œê·¸ë¨ ì—¬ëŸ¬ê°œë¥¼ ì¼œê³  ë§ˆì§€ë§‰ìœ¼ë¡œ ë©”ì¼ê³¼ ì—…ë¬´ìš© ë©”ì‹ ì €ë“¤ì„ í™•ì¸í•œë‹¤. ì¼ì„ ì‹œì‘ í•  ì‹œê°„ì´ë‹¤. ì‚¬ëŒì˜ í˜•ìƒì„ ì‚¬ë‘í•œë‹¤. ì•„ì£¼ ì–´ë¦´ ì  ë¶€í„°ë„ ì¸í˜•ì„ ë¹„ë¡¯í•´ ê·¸ëƒ¥, ì‚¬ëŒì˜ ëª¨ì–‘ì´ ì¢‹ì•˜ë‹¤. ì‚¬ëŒê³¼ ê·¸ ë§ˆìŒ ìì²´ë¥¼ ì‚¬ë‘í•œë‹¤ëŠ” ìˆ˜ë§ì€ ìë“¤ì˜ ë…¸ë«ë§ë“¤ë³´ë‹¤ë„... ë‚œ ì‚¬ëŒì˜ ì†ê°€ë½, ì†í†±, ì•ˆêµ¬ì™€ í™ì±„ì™€ ë¼ˆ, ë¶ˆê±°ì§€ëŠ” í˜ì¤„ë“±ì˜ í˜•ì²´ê°€ ì¢‹ì•˜ë‹¤. ë³´ë“œëê³  ë§ë‘ê±°ë¦´ ê²ƒ ê°™ì€ í”¼ë¶“ê²°ê³¼ íƒ„íƒ„í•˜ê²Œ ì¡°ì—¬ì§€ëŠ” ê·¼ìœ¡ ì‚¬ì´ì˜ ê³ ë‘ ê°™ì€ ê²ƒì´ ì¢‹ì•˜ë‹¤. ë¯¸ì ìœ¼ë¡œ ì•„ë¦„ë‹µê¸°ë§Œ í•˜ë‹¤ë©´ êµ³ì´ í˜„ì‹¤ì˜ ì‚¬ëŒì´ ì•„ë‹ˆì–´ë„ ì¢‹ì•˜ë‹¤. ì•„ì£¼ ì¼ë¶€ë§Œ ì‚¬ëŒì˜ í˜•íƒœë¥¼ ê°€ì§„ ê²ƒì´ì–´ë„ ì¢‹ì•˜ë‹¤. ë•ë¶„ì— ì‚¬ëŒ ê·¸ ìì²´ì™€ ì‚¬ëŒì˜ í˜•íƒœë¼ëŠ” ê²ƒì— ëŒ€í•œ ì •ì˜ê°€ ë§¤ìš° ë„“ì–´ì¡Œì—ˆì§€. ì†ì€ í…… ë¹„ê³  ê²‰ ê»ì§ˆë§Œ ì¡´ì¬í•˜ëŠ” í˜•íƒœë“¤ì˜ ì§‘í•©, ì¸ì‹í•˜ëŠ” ê²ƒë§Œì´ ì¡´ì¬í•˜ëŠ” ì„¸ìƒ. 3Dë¡œ êµ¬í˜„ëœ ë””ì§€í„¸ ì„¸ê³„ì˜ ì‚¬ëŒì„ ë§Œë“œëŠ” ì‚¬ëŒ. ê·¸ê²Œ ë‚˜ê³  ë‚˜ì˜ ì¼ì´ë‹¤. 3Dëª¨ë¸ë§ì€ ì‹œê°„ì´ ì˜¤ë˜ ê±¸ë¦¬ëŠ” ì‘ì—…ì´ë‹¤. ê¸°íšì„œë¥¼ ì½ê³  ë ˆí¼ëŸ°ìŠ¤ë¥¼ ìˆ˜ì§‘í•˜ê³  í˜•íƒœë¥¼ ë§Œë“œëŠ” ê²ƒë§Œì´ ë‹¤ê°€ ì•„ë‹ˆë‹¤. ëˆˆì´ë¼ëŠ” ê²ƒì€ ì˜ˆë¯¼í•œ ê²ƒì´ì–´ì„œ ì¡°ê¸ˆë§Œ ì–´ìƒ‰í•œ ì ì´ ë³´ì—¬ë„ ìœ„í™”ê°ì„ ëŠë¼ê¸° ì‹œì‘í•œë‹¤. ê·¸ëŸ° ëˆˆì„ ì„¤ë“ì‹œì¼œ ì•„ë¦„ë‹¤ìš´ ì‚¬ëŒì˜ í˜•íƒœë¼ëŠ” ê²ƒì„ ë‚©ë“ì‹œì¼œì•¼ë§Œ í•œë‹¤. 0.01mmì˜ ìœ„ì¹˜ ì°¨ì´ê°€ ì¸ìƒì„ ê²°ì •í•œë‹¤. ì•„ì£¼ ë¯¸ë¬˜í•œ ì„¸ê¸°ì™€ ê°ë„ ì°¨ì´ë¡œë„ ê²°ê³¼ë¬¼ì˜ ëŠë‚Œì€ ì²œì°¨ë§Œë³„ì´ë‹¤. í˜•íƒœ ìœ„ì— ì§ˆê°ì„ ë¬˜ì‚¬í•˜ê³  ìƒ‰ê°ì„ ì…íˆê³  ë¹›ì„ ì˜ì´ê¸° ì‹œì‘í•˜ë©° 'ê·¸ëŸ´ ë“¯í•œ ëŠë‚Œ'ì„ ë§Œë“œëŠ” ê²ƒì— ì‹œê°„ì„ ë§ì´ ì†Œëª¨í•œë‹¤. ê·¸ëŸ° ì‘ì€ ìˆ˜ì •ë“¤ì„ ìˆ˜ ì²œ ìˆ˜ ë§Œ ë²ˆì„ ë°˜ë³µí•´ ê°€ë©° ê²°ê³¼ë¬¼ì„ ë¹šì–´ ë‚¸ë‹¤. í”¼ê³¤í•œ ëˆˆì— ì¸ê³µ ëˆˆë¬¼ì„ í˜ë ¤ ë„£ìœ¼ë©° ë“œë””ì–´ ì´ˆì ë§ˆì € ì¡íˆì§€ ì•Šì„ ì •ë„ë¡œ ì§‘ì¤‘í•˜ëŠ” 8ì‹œê°„ì´ ì§€ë‚˜ê³  ë‚˜ë©´ í•˜ë£¨ì¹˜ ì¼ì´ ëì´ ë‚œë‹¤. ì˜¤ëŠ˜ì€ ì–¼ë§ˆë‚˜ ë” ì§„ì§œê°™ì€, í˜¹ì€ í™˜ìƒê³¼ë„ ê°™ì´ ì•„ë¦„ë‹¤ìš´ ì¸ê°„ì˜ í˜•ì²´ë¥¼ ë§Œë“¤ ìˆ˜ ìˆì—ˆëŠ”ê°€? ì§‘ìœ¼ë¡œ ëŒì•„ê°ˆ ë•Œì—ëŠ” ì¶œê·¼ í•  ë•Œ 10ë¶„ì •ë„ ë²„ìŠ¤ë¥¼ íƒ€ë˜ ê¸¸ì„ ê·¸ëƒ¥ ê±¸ì–´ì„œ ëŒì•„ê°„ë‹¤. í‡´ê·¼ê¸¸ì€ ì‹œì›ìŠ¤ë ˆ ëš«ë¦° í° ê¸¸ì´ë‹¤. ì§€í•˜ì² ì—­ ê¹Œì§€ëŠ” ì¥ì• ë¬¼ ë“±ì´ ê±°ì˜ ì—†ê¸° ë•Œë¬¸ì— íë¦° ëˆˆì„ ì ì‹œ ê°ê³  ê±¸ì–´ë„ ë¶€ë”›íˆëŠ” ì¼ ë”°ìœ„ëŠ” ì—†ë‹¤. ì•ˆê²½ì„ ë²—ê³  ì˜¤ë¥¸ìª½ì„ íë¥´ëŠ” ë¹›ë¬´ë¦¬ë“¤ì„, ìœ¤ìŠ¬ê³¼ë„ ê°™ì€ ê¸¸ì¡ì´ë¥¼ ë”°ë¼ ê±¸ì–´ê°„ë‹¤. ë¶„ëª…í•œ ê²ƒ í•˜ë‚˜ ì—†ëŠ” í˜•ì²´ê°€ ì˜¤íˆë ¤ ë§ˆìŒì— ë“¤ì—ˆë‹¤. ëˆˆ ì•ì´ íë ¤ë„ ê±·ëŠ” ë°œê±¸ìŒì€ ë©ˆì¶”ì§€ ì•ŠëŠ”ë‹¤. ë…¸ê³¤í•œ ëª¸ì´ ì˜¤íˆë ¤ ê¿ˆ ì† ê°™ì€ ê¸°ë¶„ì´ ë“¤ê²Œ í•œë‹¤. ì—¬ëŠ ë•Œì™€ ê°™ì€ í‡´ê·¼ê¸¸ì´ë‹¤. ë‚´ì¼ì˜ ì‘ì—…ê³¼ ë§ˆê°ì„ ìƒê°í•˜ë©´ ì„¤ë ˆëŠ” ë§ˆìŒì„ ë„ë‹¥ë„ë‹¥í•˜ë©° ì§‘ìœ¼ë¡œ ëŒì•„ê°„ë‹¤.  
 
**í•™ìƒ ì¼ê¸° í”¼ë“œë°± (10ê°œ ë¬¸ì¥ ì„ ì •):**  
1. **ê¸°ì¡´ ë¬¸ì¥**: "ëˆˆ ì•ìœ¼ë¡œëŠ” ê¸¸ì´ ì­‰ ë»—ì–´ ìˆì—ˆì§€ë§Œ ì € ë„íŠ¸ë¨¸ë¦¬ì˜ ê±´ë¬¼ ê¼­ëŒ€ê¸°ë¥¼ ë°”ë¼ë³´ë ¤ í•´ë„ ì´ˆì ì´ ì˜ ì¡íˆì§€ ì•Šì•˜ë‹¤."  
**ì´ìœ  ë° ê°œì„ ì **: "ëˆˆ ì•"ì€ í•œ ë‹¨ì–´ë¡œ ë¶™ì—¬ ì¨ì•¼ í•´ìš”. ë„ì–´ì“°ê¸°ë¥¼ ìˆ˜ì •í•˜ë©´ ë” ìì—°ìŠ¤ëŸ¬ì›Œì§ˆ ê±°ì˜ˆìš”! (ê¸°ì¤€ 2: ë„ì–´ì“°ê¸°)  
**ìˆ˜ì • ë¬¸ì¥**: "ëˆˆì•ì—ëŠ” ê¸¸ì´ ì­‰ ë»—ì–´ ìˆì—ˆì§€ë§Œ ì € ë„íŠ¸ë¨¸ë¦¬ì˜ ê±´ë¬¼ ê¼­ëŒ€ê¸°ë¥¼ ë°”ë¼ë³´ë ¤ í•´ë„ ì´ˆì ì´ ì˜ ì¡íˆì§€ ì•Šì•˜ë‹¤."  

2. **ê¸°ì¡´ ë¬¸ì¥**: "ë‹¹ì¥ ì½” ì•ì˜ ë‚´ ì† ì¡°ì°¨ íë¦¿í•˜ê²Œ í¼ì ¸ ë³´ì´ëŠ”ë° ë¨¼ ê³³ì„ ë³´ë ¤ê³  í•˜ë‹¤ë‹ˆ ìš©ê¸°ê°€ ê°€ìƒí•˜ë‹¤."  
**ì´ìœ  ë° ê°œì„ ì **: "ì½” ì•"ë„ í•œ ë‹¨ì–´ë¡œ ë¶™ì—¬ ì“°ê³ , "ìš©ê¸°ê°€ ê°€ìƒí•˜ë‹¤"ëŠ” í‘œí˜„ë³´ë‹¤ "ëŒ€ë‹¨í•˜ë‹¤"ê°€ ë” ì–´ìš¸ë ¤ìš”. (ê¸°ì¤€ 1: ì‰½ê³  ëª…í™•í•œ ë‹¨ì–´, ê¸°ì¤€ 2: ë„ì–´ì“°ê¸°)  
**ìˆ˜ì • ë¬¸ì¥**: "ë‹¹ì¥ ì½”ì•ì˜ ë‚´ ì†ì¡°ì°¨ íë¦¿í•˜ê²Œ í¼ì ¸ ë³´ì´ëŠ”ë° ë¨¼ ê³³ì„ ë³´ë ¤ê³  í•˜ë‹¤ë‹ˆ ìš©ê¸°ê°€ ëŒ€ë‹¨í•˜ë‹¤."  

3. **ê¸°ì¡´ ë¬¸ì¥**: "ì»´í“¨í„° ì „ì›ì„ ëˆ„ë¥´ê³  ë¶€íŒ…ì„ ê¸°ë‹¤ë¦¬ëŠ” ì•½ê°„ì˜ ì‹œê°„ ì‚¬ì´ì— ì§„í•œ ì»¤í”¼ í•œ ì”ì„ ë‚´ë¦°ë‹¤."  
**ì´ìœ  ë° ê°œì„ ì **: ë¬¸ì¥ì´ ê¸¸ì–´ì„œ ë‘ ë¬¸ì¥ìœ¼ë¡œ ë‚˜ëˆ„ë©´ ë” ê¹”ë”í•´ì ¸ìš”! (ê¸°ì¤€ 3: ë¬¸ì¥ ê¸¸ì´)  
**ìˆ˜ì • ë¬¸ì¥**: "ì»´í“¨í„° ì „ì›ì„ ëˆŒëŸ¬ ë¶€íŒ…ì„ ê¸°ë‹¤ë¦°ë‹¤. ê·¸ì‚¬ì´ ì§„í•œ ì»¤í”¼ í•œ ì”ì„ ë‚´ë¦°ë‹¤."  

4. **ê¸°ì¡´ ë¬¸ì¥**: "ìë¦¬ì— ì•‰ìœ¼ë©´ ì½”ëì—ì„œ ì•ìœ¼ë¡œ ì•½ 60cmì˜ ê±°ë¦¬ë¥¼ ë‘” 32ì¸ì¹˜ ëª¨ë‹ˆí„° ë‘ ëŒ€, íƒ€ë¸”ë › í•œ ê²Œì™€ ê¸°ê³„ì‹ ë°±ì¶• í‚¤ë³´ë“œ í•œ ëŒ€, ê°ì¢… ë‹¨ì¶•í‚¤ë¥¼ ë“±ë¡í•œ ê²Œì´ë°ìš© ë§ˆìš°ìŠ¤ í•œ ê°œê°€ ì„¸íŒ…ë˜ì–´ ìˆë‹¤."  
**ì´ìœ  ë° ê°œì„ ì **: ì¥ë¹„ ì„¤ëª…ì´ ê¸¸ì–´ì„œ ë¬¸ì¥ì„ ë‚˜ëˆ„ê³ , "ì„¸íŒ…ë˜ì–´ ìˆë‹¤"ë¥¼ ëŠ¥ë™íƒœë¡œ ë°”ê¾¸ë©´ ì¢‹ì•„ìš”! (ê¸°ì¤€ 3: ë¬¸ì¥ ê¸¸ì´, ê¸°ì¤€ 4: ëŠ¥ë™íƒœ)  
**ìˆ˜ì • ë¬¸ì¥**: "ìë¦¬ì— ì•‰ìœ¼ë©´ ì½”ëì—ì„œ ì•½ 60cm ê±°ë¦¬ì— 32ì¸ì¹˜ ëª¨ë‹ˆí„° ë‘ ëŒ€ê°€ ìˆë‹¤. íƒ€ë¸”ë › í•œ ê°œ, ê¸°ê³„ì‹ ë°±ì¶• í‚¤ë³´ë“œ, ê²Œì´ë°ìš© ë§ˆìš°ìŠ¤ë„ í•¨ê»˜ ì„¸íŒ…í–ˆë‹¤."  

5. **ê¸°ì¡´ ë¬¸ì¥**: "ì¼ì„ ì‹œì‘ í•  ì‹œê°„ì´ë‹¤."  
**ì´ìœ  ë° ê°œì„ ì **: "ì‹œì‘ í• "ì€ "ì‹œì‘í• "ë¡œ ë¶™ì—¬ ì¨ì•¼ í•´ìš”. (ê¸°ì¤€ 2: ë„ì–´ì“°ê¸°)  
**ìˆ˜ì • ë¬¸ì¥**: "ì¼ì„ ì‹œì‘í•  ì‹œê°„ì´ë‹¤."  

6. **ê¸°ì¡´ ë¬¸ì¥**: "ì•„ì£¼ ì–´ë¦´ ì  ë¶€í„°ë„ ì¸í˜•ì„ ë¹„ë¡¯í•´ ê·¸ëƒ¥, ì‚¬ëŒì˜ ëª¨ì–‘ì´ ì¢‹ì•˜ë‹¤."  
**ì´ìœ  ë° ê°œì„ ì **: "ë¶€í„°"ëŠ” "ë¶€í„°"ë¡œ ìˆ˜ì •í•˜ê³ , "ì•„ì£¼"ëŠ” ìƒëµí•´ë„ ì˜ë¯¸ê°€ ì¶©ë¶„í•´ìš”. (ê¸°ì¤€ 2: ë§ì¶¤ë²•, ê¸°ì¤€ 5: ë¶€ì‚¬ ìµœì†Œí™”)  
**ìˆ˜ì • ë¬¸ì¥**: "ì–´ë¦´ ì ë¶€í„°ë„ ì¸í˜•ì„ ë¹„ë¡¯í•´ ì‚¬ëŒì˜ ëª¨ì–‘ì´ ì¢‹ì•˜ë‹¤."  

7. **ê¸°ì¡´ ë¬¸ì¥**: "ì‚¬ëŒê³¼ ê·¸ ë§ˆìŒ ìì²´ë¥¼ ì‚¬ë‘í•œë‹¤ëŠ” ìˆ˜ë§ì€ ìë“¤ì˜ ë…¸ë«ë§ë“¤ë³´ë‹¤ë„..."  
**ì´ìœ  ë° ê°œì„ ì **: "ìë“¤"ë³´ë‹¤ "ì‚¬ëŒë“¤"ì´ ë” ìì—°ìŠ¤ëŸ¬ì›Œìš”. (ê¸°ì¤€ 1: ì‰½ê³  ëª…í™•í•œ ë‹¨ì–´)  
**ìˆ˜ì • ë¬¸ì¥**: "ì‚¬ëŒê³¼ ê·¸ ë§ˆìŒ ìì²´ë¥¼ ì‚¬ë‘í•œë‹¤ëŠ” ìˆ˜ë§ì€ ì‚¬ëŒë“¤ì˜ ë…¸ë«ë§ë³´ë‹¤ë„..."  

8. **ê¸°ì¡´ ë¬¸ì¥**: "ë¶ˆê±°ì§€ëŠ” í˜ì¤„ë“±ì˜ í˜•ì²´ê°€ ì¢‹ì•˜ë‹¤."  
**ì´ìœ  ë° ê°œì„ ì **: "í˜ì¤„ë“±"ì€ "í˜ì¤„ ë“±"ìœ¼ë¡œ ë„ì–´ ì¨ì•¼ í•´ìš”. (ê¸°ì¤€ 2: ë„ì–´ì“°ê¸°)  
**ìˆ˜ì • ë¬¸ì¥**: "ë¶ˆê±°ì§€ëŠ” í˜ì¤„ ë“±ì˜ í˜•ì²´ê°€ ì¢‹ì•˜ë‹¤."  

9. **ê¸°ì¡´ ë¬¸ì¥**: "ë³´ë“œëê³  ë§ë‘ê±°ë¦´ ê²ƒ ê°™ì€ í”¼ë¶“ê²°ê³¼ íƒ„íƒ„í•˜ê²Œ ì¡°ì—¬ì§€ëŠ” ê·¼ìœ¡ ì‚¬ì´ì˜ ê³ ë‘ ê°™ì€ ê²ƒì´ ì¢‹ì•˜ë‹¤."  
**ì´ìœ  ë° ê°œì„ ì **: "í”¼ë¶“ê²°"ì€ "í”¼ë¶€ ê²°"ë¡œ ë„ì–´ ì“°ê³ , "ì¡°ì—¬ì§€ëŠ”" ëŒ€ì‹  "ì¡°ì´ëŠ”"ì´ ë” ê°„ê²°í•´ìš”. (ê¸°ì¤€ 2: ë„ì–´ì“°ê¸°, ê¸°ì¤€ 4: ëŠ¥ë™íƒœ)  
**ìˆ˜ì • ë¬¸ì¥**: "ë³´ë“œëê³  ë§ë‘ê±°ë¦´ ê²ƒ ê°™ì€ í”¼ë¶€ ê²°ê³¼ íƒ„íƒ„í•˜ê²Œ ì¡°ì´ëŠ” ê·¼ìœ¡ ì‚¬ì´ì˜ ê³ ë‘ì´ ì¢‹ì•˜ë‹¤."  

10. **ê¸°ì¡´ ë¬¸ì¥**: "ì†ì€ í…… ë¹„ê³  ê²‰ ê»ì§ˆë§Œ ì¡´ì¬í•˜ëŠ” í˜•íƒœë“¤ì˜ ì§‘í•©, ì¸ì‹í•˜ëŠ” ê²ƒë§Œì´ ì¡´ì¬í•˜ëŠ” ì„¸ìƒ."  
**ì´ìœ  ë° ê°œì„ ì **: "ê²‰ ê»ì§ˆ"ì€ "ê²‰ê»ì§ˆ"ë¡œ ë¶™ì—¬ ì“°ê³ , ë¬¸ì¥ ëì— ë§ˆë¬´ë¦¬ í‘œí˜„ì„ ì¶”ê°€í•´ ë³´ì„¸ìš”! (ê¸°ì¤€ 2: ë„ì–´ì“°ê¸°, ê¸°ì¤€ 3: ë‚´ìš© ì™„ê²°ì„±)  
**ìˆ˜ì • ë¬¸ì¥**: "ì†ì€ í…… ë¹„ê³  ê²‰ê»ì§ˆë§Œ ì¡´ì¬í•˜ëŠ” í˜•íƒœë“¤ì˜ ì§‘í•©, ì¸ì‹í•˜ëŠ” ê²ƒë§Œì´ ì¡´ì¬í•˜ëŠ” ì„¸ìƒì´ì—ˆë‹¤."  

**ì´í‰**:  
ì¼ê¸°ì—ì„œ ì‘ì—… ê³¼ì •ê³¼ ê°ì •ì„ ì„¸ë°€í•˜ê²Œ í‘œí˜„í•œ ì ì´ ì •ë§ ì¸ìƒì ì´ì—ìš”! ì¡°ê¸ˆë§Œ í‘œí˜„ì„ ë‹¤ë“¬ìœ¼ë©´ ì™„ì„±ë„ê°€ í›¨ì”¬ ë†’ì•„ì§ˆ ê±°ì˜ˆìš”. íŠ¹íˆ ê¸´ ë¬¸ì¥ì„ ë‚˜ëˆ„ê³  ë„ì–´ì“°ê¸°ë¥¼ ìˆ˜ì •í•˜ë©´ ì½ê¸° í¸í•´ì§ˆ ê±°ëë‹ˆë‹¤. ì•ìœ¼ë¡œë„ ê¾¸ì¤€íˆ ì“°ë‹¤ ë³´ë©´ ìì—°ìŠ¤ëŸ¬ìš´ ë¬¸ì¥ì´ ìˆ ìˆ  ë‚˜ì˜¬ í…Œë‹ˆ í™”ì´íŒ…ì…ë‹ˆë‹¤ :)"""


class CompletionExecutor:
    def __init__(self, model_name):
        if "HCX" in model_name:
            self._host = f"https://clovastudio.stream.ntruss.com/testapp/v1/chat-completions/{model_name}"
        else:
            self._host = f"https://clovastudio.stream.ntruss.com/testapp/v2/tasks/{model_name}/chat-completions"
        self._api_key = os.getenv("NAVER_API_KEY")

        self.request_data = {
            "topP": 0.3,
            "topK": 0,
            "maxTokens": 4096,
            "temperature": 0.5,
            "repeatPenalty": 5.0,
            "stopBefore": [],
            "includeAiFilters": True,
            "seed": 0,
        }

        self.prompt = [
            {
                "role": "system",
                "content": feedback_prompt,
            },
            {"role": "user", "content": None},
        ]

    async def execute(self, session, diary):
        headers = {
            "Authorization": self._api_key,
            "Content-Type": "application/json; charset=utf-8",
        }
        self.prompt[1]["content"] = f"**ì¼ê¸°**:  \n{diary}"
        self.request_data["messages"] = self.prompt

        async with session.post(
            self._host, headers=headers, json=self.request_data
        ) as response:
            response_body = await response.json()
            return response_body["result"]["message"]["content"]


def parse_feedback_review(diary, feedback):
    patterns = {
        "original_sentence": r"\d+\.\s*\*\*ê¸°ì¡´ ë¬¸ì¥\*\*:\s*(.*?)\*\*ì´ìœ  ë° ê°œì„ ì \*\*",
        "feedback": r"\*\*ì´ìœ  ë° ê°œì„ ì \*\*:\s*(.*?)\*\*ìˆ˜ì • ë¬¸ì¥\*\*",
        "updated_sentence": r"\*\*ìˆ˜ì • ë¬¸ì¥\*\*:\s*(.*?)(?=\d+\.\s*\*\*ê¸°ì¡´ ë¬¸ì¥\*\*|\*\*ì´í‰\*\*)",
        "review": r"\*\*ì´í‰\*\*:(.*)",
    }

    # 1. ì¼ê¸° í”¼ë“œë°±ê³¼ ë¦¬ë·° íŒŒì‹±í•˜ê¸°
    data = dict()
    for key, pattern in patterns.items():
        matches = re.findall(pattern, feedback, re.DOTALL)  # íŒ¨í„´ì— ë§ëŠ” ë¬¸ìì—´ ì°¾ê¸°
        data[key] = [
            match.strip().strip('"') for match in matches
        ]  # ì–‘ë ê³µë°± ë° ë”°ì˜´í‘œ ì œê±°

    # 2. í˜•ì‹ì— ë§ê²Œ ë³€í™˜ (start_idx, end_idx, feedback, updated_sentence)
    feedbacks = []
    for idx, original_sentence in enumerate(data["original_sentence"]):
        matches = re.search(re.escape(original_sentence), diary)
        if matches:
            feedbacks.append(
                [
                    matches.start(),
                    matches.end(),
                    data["feedback"][idx],
                    data["updated_sentence"][idx],
                ]
            )
        else:
            feedbacks.append(
                [-1, -1, data["feedback"][idx], data["updated_sentence"][idx]]
            )

    # 3. feedbacks JSONìœ¼ë¡œ ì €ì¥í•˜ê¸° ìœ„í•´ ì§ë ¬í™”
    feedbacks = json.dumps(feedbacks, ensure_ascii=False)
    review = data["review"][0] if data["review"] else ""
    print(f"feedback: {feedback}")
    print(f"review: {review}")
    return feedbacks, review


async def generate_save_feedback(api, session, conn, diary_id, text):
    """ê° ì¼ê¸°ë§ˆë‹¤ í”¼ë“œë°±ì„ ìƒì„±í•˜ê³  ì¦‰ì‹œ DBì— ì €ì¥í•˜ëŠ” í•¨ìˆ˜"""

    # 1. (ë¹„ë™ê¸°) HCXë¡œ ì¼ê¸° í”¼ë“œë°± ìƒì„±
    feedback = await api.execute(session, text)  # í”¼ë“œë°± ìƒì„±
    # 2. (ë™ê¸°) ì¼ê¸° í”¼ë“œë°±ê³¼ ë¦¬ë·° íŒŒì‹±í•˜ê¸°
    feedbacks, review = parse_feedback_review(text, feedback)
    # 3. (ë¹„ë™ê¸°) ì¼ê¸° í”¼ë“œë°±ê³¼ ë¦¬ë·° DB ì €ì¥í•˜ê¸°
    await conn.execute(
        "UPDATE DIARIES SET FEEDBACK = $1, REVIEW = $2, STATUS = 2 WHERE DIARY_ID = $3",
        feedbacks,
        review,
        diary_id,
    )

    print(f"âœ… Diary {diary_id} ì—…ë°ì´íŠ¸ ì™„ë£Œ.")


async def generate_save_feedbacks(api, t1):
    """ë¹„ë™ê¸° API ìš”ì²­ ë° ë°ì´í„°ë² ì´ìŠ¤ ì—…ë°ì´íŠ¸"""
    diaries = t1.xcom_pull(task_ids="fetch_yesterday_diary")

    # 1. Airflowì˜ PostgresHookì„ í†µí•´ ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ì •ë³´ë¥¼ ê°€ì ¸ì˜´
    pg_hook = PostgresHook(postgres_conn_id="my_postgres_conn")
    # 2. asyncpgë¥¼ ì‚¬ìš©í•˜ì—¬ ë¹„ë™ê¸°ì ìœ¼ë¡œ PostgreSQL ë°ì´í„°ë² ì´ìŠ¤ì— ì—°ê²°
    conn = await asyncpg.connect(dsn=pg_hook.get_uri().split("?")[0])

    async with aiohttp.ClientSession() as session:
        # 3. ì¼ê¸° í”¼ë“œë°± ìƒì„±í•˜ëŠ” íƒœìŠ¤í¬ ìƒì„± ë° ì´ë²¤íŠ¸ ë£¨í”„ì— ì‹¤í–‰ ì˜ˆì•½
        tasks = [
            asyncio.create_task(
                generate_save_feedback(api, session, conn, diary[0], diary[1])
            )
            for diary in diaries
        ]
        # 4. ëª¨ë“  íƒœìŠ¤í¬ê°€ ì™„ë£Œë  ë•Œê¹Œì§€ ëŒ€ê¸°
        await asyncio.gather(*tasks)

    # 5. ë¹„ë™ê¸°ì ìœ¼ë¡œ PostgreSQL ë°ì´í„°ë² ì´ìŠ¤ì— ì—°ê²° í•´ì œ
    await conn.close()
    print("ğŸ¯ ëª¨ë“  í”¼ë“œë°± ìƒì„± ë° ì €ì¥ ì™„ë£Œ.")


def trigger_feedback_generation(api, **kwargs):
    asyncio.run(generate_save_feedbacks(api, kwargs["ti"]))


default_args = {"owner": "airflow", "retries": 0, "retry_delay": timedelta(seconds=5)}

with DAG(
    dag_id="diary_feedback_async",
    default_args=default_args,
    start_date=datetime(2025, 1, 25),
    schedule_interval="0 1 * * *",
    catchup=True,
    tags=["diary_feedback"],
) as dag:
    completion_executor = CompletionExecutor(model_name="lmh7w4qy")

    # 1. ì–´ì œ ì œì¶œí•œ ì¼ê¸° ê°€ì ¸ì˜¤ê¸°
    get_yesterday_diaries_task = PostgresOperator(
        task_id="fetch_yesterday_diary",
        postgres_conn_id="my_postgres_conn",
        sql="""
            SELECT diary_id, text
            FROM DIARIES
            WHERE created_at::date = '{{ macros.ds_add(ds, -1) }}'::date AND status = 2
        """,
        do_xcom_push=True,
    )

    generate_save_diary_feedback_task = PythonOperator(
        task_id="generate_save_diary_feedback",
        python_callable=trigger_feedback_generation,
        op_kwargs={"api": completion_executor},
    )

    get_yesterday_diaries_task >> generate_save_diary_feedback_task
